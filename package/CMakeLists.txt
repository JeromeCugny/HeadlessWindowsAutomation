# NuGet packaging
set(NUGET_PACKAGE_NAME "${PROJECT_NAME}")

# Generate the .nuspec file at build time
set(NUSPEC_FILE "${CMAKE_BINARY_DIR}/${NUGET_PACKAGE_NAME}.nuspec")
set(GENERATE_NUSPEC_SCRIPT "${CMAKE_CURRENT_SOURCE_DIR}/generate_nuspec.cmake")

add_custom_command(
    OUTPUT ${NUSPEC_FILE}
    COMMAND ${CMAKE_COMMAND} -DNUSPEC_FILE=${NUSPEC_FILE} -DLIB_PATH=${OUTPUT_PATH}/$<CONFIG> -DSOURCE_PATH=${CMAKE_CURRENT_SOURCE_DIR} -DNUGET_PACKAGE_NAME=${NUGET_PACKAGE_NAME} -DNUGET_PACKAGE_VERSION=${NUGET_PACKAGE_VERSION} -DDOTNET_TARGET_FRAMEWORK=${DOTNET_TARGET_FRAMEWORK} -P ${GENERATE_NUSPEC_SCRIPT}
    DEPENDS ${PROJECT_NAME}
)

# Add a custom target to create the NuGet package
add_custom_target(NuGetPackage ALL
  COMMAND nuget pack ${CMAKE_BINARY_DIR}/${NUGET_PACKAGE_NAME}.nuspec -OutputDirectory ${DELIVERY_OUTPUT_PATH}
  DEPENDS ${NUSPEC_FILE}
)